<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- ... (mantenha todo o HEAD anterior) ... -->
</head>
<body>
    <!-- ... (mantenha todo o BODY anterior até a tag SCRIPT) ... -->

    <script>
        // ... (mantenha a configuração do Firebase e funções auxiliares) ...

        document.addEventListener('DOMContentLoaded', () => {
            // CADASTRO ALUNO CORRIGIDO
            const formAluno = document.getElementById('formCadastroAluno');
            formAluno.addEventListener('submit', async (e) => {
                e.preventDefault();
                const elements = e.target.elements;
                
                try {
                    const nome = elements[0].value;
                    const matricula = elements[1].value;
                    const email = elements[2].value;
                    const dataNasc = elements[3].value;
                    
                    // Gera usuário e senha corretamente
                    const usuario = nome.replace(/\s+/g, '').toLowerCase() + matricula;
                    const senha = formatarDataBrasileira(dataNasc);

                    await db.collection('Alunos').doc(usuario).set({
                        nomeCompleto: nome,
                        matricula: matricula,
                        email: email,
                        dataNascimento: dataNasc,
                        usuario: matricula,  // Usuário é a matrícula
                        senha: senha,
                        status: 'pendente',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log('Aluno cadastrado:', {usuario, senha});
                    mostrarModal('Cadastro Realizado', `Usuário: ${matricula}\nSenha: ${senha}`);
                    formAluno.reset();

                } catch (error) {
                    console.error('Erro no cadastro do aluno:', error);
                }
            });

            // LOGIN ALUNO CORRIGIDO
            document.getElementById('formLoginAluno').addEventListener('submit', async (e) => {
                e.preventDefault();
                const matricula = e.target.elements[0].value;
                const senhaDigitada = formatarDataBrasileira(e.target.elements[1].value);

                try {
                    const snapshot = await db.collection('Alunos')
                        .where('usuario', '==', matricula)
                        .where('senha', '==', senhaDigitada)
                        .get();

                    console.log('Resultado consulta:', snapshot.docs.map(d => d.data()));

                    if (snapshot.empty) {
                        mostrarModal('Erro', 'Credenciais inválidas!');
                        return;
                    }

                    const aluno = snapshot.docs[0].data();
                    console.log('Aluno encontrado:', aluno);

                    // Verificação de status
                    if (aluno.status === 'pendente') {
                        mostrarModal('Aviso', 'Seu cadastro está aguardando aprovação');
                        mostrarTela('login-aluno');
                    } else if (aluno.status === 'negado') {
                        mostrarModal('Erro', 'Cadastro não aprovado! Contate o suporte.');
                        mostrarTela('login-aluno');
                    } else {
                        mostrarModal('Sucesso', 'Login realizado com sucesso!');
                        mostrarTela('area-aluno');
                    }

                } catch (error) {
                    console.error('Erro no login:', error);
                }
            });

            // LOGIN PACIENTE CORRIGIDO
            document.getElementById('formLoginPaciente').addEventListener('submit', async (e) => {
                e.preventDefault();
                const usuario = e.target.elements[0].value;
                const senhaDigitada = formatarDataBrasileira(e.target.elements[1].value);

                try {
                    const snapshot = await db.collection('Pacientes')
                        .where('usuario', '==', usuario)
                        .where('senha', '==', senhaDigitada)
                        .get();

                    console.log('Resultado consulta paciente:', snapshot.docs.map(d => d.data()));

                    if (!snapshot.empty) {
                        mostrarModal('Sucesso', 'Login realizado com sucesso!');
                        mostrarTela('tela-modulos');
                    } else {
                        mostrarModal('Erro', 'Credenciais inválidas!');
                    }

                } catch (error) {
                    console.error('Erro no login do paciente:', error);
                }
            });
        });
    </script>
</body>
</html>

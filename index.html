async function editarUsuario(id) {
    const doc = await db.collection('Alunos').doc(id).get();
    const usuario = doc.data();

    const form = document.createElement('form');
    form.className = 'edit-form';
    form.innerHTML = `
        <input type="text" name="nomeCompleto" value="${usuario.nomeCompleto}" placeholder="Nome Completo" required>
        <input type="text" name="matricula" value="${usuario.matricula}" placeholder="Matrícula" required>
        <input type="email" name="email" value="${usuario.email}" placeholder="Email" required>
        <input type="date" name="dataNascimento" value="${usuario.dataNascimento}" required>
        <input type="text" name="whatsapp" value="${usuario.whatsapp}" placeholder="WhatsApp" required>
        <input type="text" name="senha" value="${usuario.senha}" placeholder="Senha" required>
        <select name="admin">
            <option value="no" ${usuario.admin !== 'yes' ? 'selected' : ''}>Usuário Comum</option>
            <option value="yes" ${usuario.admin === 'yes' ? 'selected' : ''}>Administrador</option>
        </select>
        <select name="status">
            <option value="aprovado" ${usuario.status === 'aprovado' ? 'selected' : ''}>Aprovado</option>
            <option value="pendente" ${usuario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
            <option value="negado" ${usuario.status === 'negado' ? 'selected' : ''}>Negado</option>
        </select>
        <textarea name="motivoNegacao" placeholder="Motivo da negação (obrigatório se negado)" ${usuario.status === 'negado' ? `value="${usuario.motivoNegacao || ''}"` : ''}></textarea>
        <button type="submit">Salvar</button>
        <button type="button" onclick="excluirUsuario('${id}')">Excluir</button>
    `;

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            nomeCompleto: form.nomeCompleto.value,
            matricula: form.matricula.value,
            email: form.email.value,
            dataNascimento: form.dataNascimento.value,
            whatsapp: form.whatsapp.value,
            senha: form.senha.value, // Incluída a senha no objeto de atualização
            admin: form.admin.value,
            status: form.status.value
        };

        if (form.status.value === 'negado') {
            if (!form.motivoNegacao.value) {
                alert('O motivo da negação é obrigatório ao negar um usuário.');
                return;
            }
            data.motivoNegacao = form.motivoNegacao.value;
            data.negadoPor = auth.currentUser ? auth.currentUser.uid : 'admin';
        } else {
            data.motivoNegacao = firebase.firestore.FieldValue.delete();
            data.negadoPor = firebase.firestore.FieldValue.delete();
        }

        await db.collection('Alunos').doc(id).update(data);
        fecharModal();
    });

    mostrarModal('Editar Usuário', form, 'sucesso');
}
